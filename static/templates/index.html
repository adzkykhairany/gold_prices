<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Gold Prices Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">XAU</div>
        <div>
          <h1>Gold Prices — XAU / USD</h1>
          <p class="lead">Historical gold price.</p>
        </div>
      </div>
      <div class="controls">
        <div style="text-align:right;color:var(--muted);font-size:13px">Data source: <a href="https://www.goldapi.io">goldapi.io</a></div>
      </div>
    </header>

    <div class="card">
      <nav class="nav" role="navigation" aria-label="Main">
        <button id="tab-historical" class="active">Historical Table</button>
        <button id="tab-chart">Chart</button>
      </nav>

      <div class="grid">
        <!-- Historical table (default) -->
        <section id="section-historical">
          <h3 style="margin-top:0">1‑Year Historical Prices</h3>
          {% if data %}
          <div class="table-wrap">
            <table aria-describedby="1-year-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Close</th>
                  <th>Open</th>
                  <th>High</th>
                  <th>Low</th>
                  <th>Change</th>
                  <th>Change (%)</th>
                </tr>
              </thead>
              <tbody>
                {% for d in data %}
                <tr>
                  <td>{{ d.date }}</td>
                  <td>{{ d.price }}</td>
                  <td>{{ d.open }}</td>
                  <td>{{ d.high }}</td>
                  <td>{{ d.low }}</td>
                  <td>{{ d.ch }}</td>
                  <td>{{ d.chp }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p style="color:#b91c1c">No data available or API limit reached.</p>
          {% endif %}
        </section>

        <!-- Chart section -->
        <section id="section-chart" style="display:none">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h3 style="margin:0">Gold Price (Line Chart)</h3>
            <div>
              <button type="button" class="period-btn {{ 'active' if period == '7' else '' }}" data-period="7">1W</button>
              <button type="button" class="period-btn {{ 'active' if period == '30' else '' }}" data-period="30">1M</button>
              <button type="button" class="period-btn {{ 'active' if period == '365' else '' }}" data-period="365">1Y</button>
            </div>
          </div>

          <div class="card chart-area" style="margin-top:12px">
            <canvas id="priceChart" height="160"></canvas>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Toggle tabs
    const tabHistorical = document.getElementById('tab-historical');
    const tabChart = document.getElementById('tab-chart');
    const secHist = document.getElementById('section-historical');
    const secChart = document.getElementById('section-chart');

    tabHistorical.addEventListener('click', ()=>{
      tabHistorical.classList.add('active');
      tabChart.classList.remove('active');
      secHist.style.display='block';
      secChart.style.display='none';
    });
    tabChart.addEventListener('click', ()=>{
      tabChart.classList.add('active');
      tabHistorical.classList.remove('active');
      secHist.style.display='none';
      secChart.style.display='block';
      // create chart when opened
      if(!window._chartCreated) createChart();
    });

    // If the URL contains view=chart, open chart tab
    const params = new URLSearchParams(window.location.search);
    if(params.get('view') === 'chart'){
      tabChart.click();
    }

    const rawData = {{ data|tojson|default('[]') }};

    // helper to get currently active period (days)
    function getActivePeriod(){
      const b = document.querySelector('.period-btn.active');
      return b ? Number(b.dataset.period) : 365;
    }

    function buildChartSlice(periodDays){
      if(!rawData || rawData.length===0) return {labels:[], values:[]};
      const ordered = rawData.slice().reverse(); // chronological
      const slice = (periodDays && periodDays < ordered.length) ? ordered.slice(-periodDays) : ordered;
      return { labels: slice.map(r=>r.date), values: slice.map(r=>Number(r.price)) };
    }

    function createChart(periodDays){
      const ctx = document.getElementById('priceChart').getContext('2d');
      const gradient = ctx.createLinearGradient(0,0,0,200);
      gradient.addColorStop(0,'rgba(11,102,255,0.18)');
      gradient.addColorStop(1,'rgba(11,102,255,0)');

      const {labels, values} = buildChartSlice(periodDays || getActivePeriod());

      window.priceChart = new Chart(ctx,{
        type:'line',
        data:{labels, datasets:[{label:'XAU/USD',data:values,fill:true,backgroundColor:gradient,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--blue-700')||'#0446c6',tension:0.2,pointRadius:0}]},
        options:{maintainAspectRatio:false,scales:{x:{display:true,grid:{display:false}},y:{grid:{color:'rgba(11,102,255,0.06)'}}},plugins:{legend:{display:false}}}
      });
      window._chartCreated = true;
    }

    function updateChart(periodDays){
      if(!window.priceChart){ createChart(periodDays); return; }
      const {labels, values} = buildChartSlice(periodDays || getActivePeriod());
      window.priceChart.data.labels = labels;
      window.priceChart.data.datasets[0].data = values;
      window.priceChart.update();
    }

    // attach handlers for period buttons (client-side, no reload)
    document.querySelectorAll('.period-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        document.querySelectorAll('.period-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const p = Number(btn.dataset.period) || 365;
        // ensure chart tab is visible
        if(secChart.style.display === 'none') tabChart.click();
        updateChart(p);
      });
    });

    if(secChart.style.display !== 'none') createChart();
  </script>
</body>
</html>
